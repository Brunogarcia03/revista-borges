---
import Logo from "../assets/svgs/Logo.astro";

const { black = "false" } = Astro.props;
---

<header
  class="fixed top-0 px-3 py-5 sm:px-5 flex items-center justify-between w-full z-999"
>
  <a href="/" id="logo-link" class="w-32">
    <Logo black={black} />
  </a>

  <button
    id="button-menu"
    aria-expanded="false"
    aria-label="Abrir menú de navegación"
    class={`relative md:hidden h-8 w-8 rounded-[.2rem] ${
      black ? "bg-black" : "bg-white"
    } cursor-pointer z-999`}
  >
    <svg
      id="svg-menu"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 -960 960 960"
      class={`absolute inset-1 m-auto h-5 w-5 ${black ? "fill-white" : "fill-black"}`}
    >
      <path
        d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"
      ></path>
    </svg>

    <svg
      id="svg-close"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 -960 960 960"
      class={`absolute inset-1 m-auto h-5 w-5 ${black ? "fill-white" : "fill-black"} opacity-0 scale-0`}
    >
      <path
        d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"
      ></path>
    </svg>
  </button>

  <nav
    class={`hidden md:flex gap-3 text-sm tracking-wide font-sans font-semibold ${black ? "text-black" : "text-white"} uppercase`}
  >
    <a
      href="/"
      class={`relative after:absolute after:bottom-0 after:left-0 after:h-px after:w-full after:origin-bottom-right after:scale-x-0 ${black ? "after:bg-black" : "after:bg-white"} after:transition-transform after:duration-300 after:ease-[cubic-bezier(0.65_0.05_0.36_1)] hover:after:origin-bottom-left hover:after:scale-x-100 cursor-pointer`}
    >
      Inicio
    </a>
    <a
      href="/articulos"
      class={`relative after:absolute after:bottom-0 after:left-0 after:h-px after:w-full after:origin-bottom-right after:scale-x-0 ${black ? "after:bg-black" : "after:bg-white"} after:transition-transform after:duration-300 after:ease-[cubic-bezier(0.65_0.05_0.36_1)] hover:after:origin-bottom-left hover:after:scale-x-100 cursor-pointer`}
    >
      Artículos
    </a>
    <a
      href="/nosotros"
      class={`relative after:absolute after:bottom-0 after:left-0 after:h-px after:w-full after:origin-bottom-right after:scale-x-0 ${black ? "after:bg-black" : "after:bg-white"} after:transition-transform after:duration-300 after:ease-[cubic-bezier(0.65_0.05_0.36_1)] hover:after:origin-bottom-left hover:after:scale-x-100 cursor-pointer`}
    >
      Sobre nosotros
    </a>
  </nav>
</header><nav
  id="nav-menu"
  class="fixed flex flex-col justify-center pl-[24%] gap-2 px-5 text-2xl font-bold font-heading uppercase inset-0 w-full h-full bg-white md:hidden z-998"
  style="clip-path: inset(0 0 0 100%);"
>
  <a href="/">Inicio</a><a href="/articulos">Artículos</a><a href="/nosotros"
    >Nosotros</a
  >
</nav>
<div
  id="background-menu"
  class="fixed inset-0 w-full h-dvh bg-black/10 z-900 md:hidden"
  style="clip-path: inset(0 0 0 100%);"
>
</div>

<script>
  import { navigate } from "astro:transitions/client";
  import { gsap } from "gsap";

  function initMenu() {
    const header = document.querySelector("header");

    const button = document.getElementById("button-menu") as HTMLButtonElement;
    const navMenu = document.getElementById("nav-menu") as HTMLElement;
    const bgMenu = document.getElementById("background-menu") as HTMLDivElement;
    const menuLinks = navMenu.querySelectorAll("a");

    const logoLink = document.getElementById("logo-link") as HTMLAnchorElement;

    const svgMenu = document.getElementById("svg-menu") as HTMLElement;
    const svgClose = document.getElementById("svg-close") as HTMLElement;

    let open = false;
    let scrollPos = 0;
    let lastScroll = 0;

    console.log(open);

    // Timeline del menú
    const menuTl = gsap.timeline({
      paused: true,
      defaults: { ease: "power3.out", duration: 0.6 },

      onStart: () => {
        scrollPos = window.scrollY || window.pageYOffset;

        document.documentElement.classList.add("lock-scroll");
        document.documentElement.style.top = `-${scrollPos}px`;
      },

      onReverseComplete: () => {
        document.documentElement.classList.remove("lock-scroll");
        document.documentElement.style.top = "";

        window.scrollTo(0, scrollPos);
        open = false;
      },
    });

    menuTl
      .to("#logo-link", {
        opacity: 0,
        y: -10,
        duration: 0.3,
      })
      .to(navMenu, {
        clipPath: "inset(0 0 0 20%)",
      })
      .to(
        button,
        {
          borderWidth: 1,
          borderStyle: "dashed",
          borderColor: "#000",
          duration: 0.4,
        },
        "<",
      )
      .to(svgMenu, { opacity: 0, scale: 0, duration: 0.1 }, "<")
      .to(svgClose, { opacity: 1, scale: 1, duration: 0.1 }, ">");

    button.addEventListener("click", () => {
      open = !open;

      gsap.to(bgMenu, {
        clipPath: open ? "inset(0 0 0 0%)" : "inset(0 0 0 100%)",
        duration: 0.6,
      });
      button.setAttribute("aria-expanded", String(open));
      button.setAttribute(
        "aria-label",
        open ? "Cerrar menú de navegación" : "Abrir menú de navegación",
      );

      open ? menuTl.play() : menuTl.reverse();
    });

    const closeMenu = () => {
      if (!open) return;

      open = false;
      button.setAttribute("aria-expanded", "false");

      gsap.to(bgMenu, {
        clipPath: "inset(0 0 0 100%)",
        duration: 0.6,
      });

      menuTl.reverse();
    };

    window.addEventListener("scroll", () => {
      let currentScroll = window.scrollY;

      if (currentScroll > lastScroll || currentScroll > 120) {
        gsap.to(header, {
          backdropFilter: "blur(2px)",
          duration: 0.5,
        });
      } else {
        gsap.to(header, {
          backdropFilter: "blur(0px)",
          duration: 0.5,
        });
      }

      lastScroll = currentScroll;
    });

    logoLink?.addEventListener("click", (e) => {
      e.preventDefault();
      const href = logoLink.getAttribute("href");
      if (!href) return;

      closeMenu();

      navigate(href);
    });

    menuLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();

        const href = link.getAttribute("href");
        if (!href) return;

        closeMenu();

        menuTl.reverse().eventCallback("onReverseComplete", () => {
          navigate(href);
        });
      });
    });
  }

  document.addEventListener("astro:page-load", initMenu);
</script>
