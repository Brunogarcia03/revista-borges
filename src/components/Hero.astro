<section class="relative w-full h-dvh overflow-hidden py-20">
  <div
    id="loader"
    class="absolute left-0 top-0 w-1.25 h-full bg-black z-40 origin-top scale-y-0"
  >
  </div>
  <div class="absolute left-0 top-0 w-full h-dvh bg-black/15 z-10"></div>
  <div
    class="absolute inset-0 w-full h-full overflow-hidden z-0 bg-neutral-800"
  >
    <img id="img1" class="absolute inset-0 w-full h-full object-cover" alt="" />
    <img
      id="img2"
      class="absolute inset-0 w-full h-full object-cover opacity-0"
      alt=""
    />
  </div>
  <div
    class="absolute inset-x-0 bottom-[10%] sm:bottom-[15%] z-40 flex flex-col items-start gap-4 sm:gap-6 px-4 sm:px-10"
  >
    <div class="flex gap-2 md:gap-3 items-center justify-center">
      <button
        id="prev"
        class="flex items-center justify-center border border-dashed border-white rounded-[.2rem] size-8 md:size-10 group bg-white hover:bg-transparent transition-colors duration-200 cursor-pointer"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="#000"
          class="fill-black transition-colors duration-300"
          ><path d="M560-240 320-480l240-240 56 56-184 184 184 184-56 56Z"
          ></path></svg
        >
      </button>
      <p
        class="p-counter overflow-hidden text-white uppercase font-bold text-xl sm:text-2xl md:text-3xl select-none"
      >
        <span id="counter" style="filter: url(#threshold)">01</span> / 04
      </p>
      <button
        id="next"
        class="flex items-center justify-center border border-dashed border-white rounded-[.2rem] size-8 md:size-10 group bg-white hover:bg-transparent transition-colors duration-200 cursor-pointer"
        ><svg
          xmlns="http://www.w3.org/2000/svg"
          height="24px"
          viewBox="0 -960 960 960"
          width="24px"
          fill="#000"
          class="fill-black transition-colors duration-300"
          ><path d="M504-480 320-664l56-56 240 240-240 240-56-56 184-184Z"
          ></path></svg
        ></button
      >
    </div>
    <div
      id="morph-container"
      class="relative w-full md:w-2xl min-h-12 sm:min-h-18 md:min-h-22 leading-none filter group"
      style="filter: url(#threshold)"
    >
      <span
        id="text1"
        class="absolute inset-0 flex sm:items-center font-heading font-semibold text-2xl sm:text-4xl md:text-6xl uppercase -tracking-wider text-white text-pretty"
      ></span>
      <span
        id="text2"
        class="absolute inset-0 flex sm:items-center font-heading font-semibold text-2xl sm:text-4xl md:text-6xl uppercase -tracking-wider text-white text-pretty"
      ></span>
    </div>
  </div>
  <div
    class="absolute max-w-20 right-0 bottom-[17%] sm:bottom-[25%] md:top-1/2 -translate-y-1/2 z-40 flex flex-col items-end justify-end gap-4 sm:gap-6 px-4 sm:px-10"
  >
    <a
      id="link"
      class="group relative flex flex-col items-center gap-2 cursor-pointer"
    >
      <!-- ICONO -->
      <div
        class="relative p-1 sm:p-2 md:p-4 rounded-[.2rem] border border-dashed border-white bg-white md:bg-transparent group-hover:bg-white flex items-center justify-center transition-colors duration-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="64px"
          viewBox="0 -960 960 960"
          width="64px"
          fill="#000"
          style="filter: url(#threshold)"
          class="size-8 md:size-16 md:-rotate-12 group-hover:rotate-0 group-hover:blur-[0px] transition-all duration-300"
          ><path
            d="M673-446.67H160v-66.66h513l-240-240L480-800l320 320-320 320-47-46.67 240-240Z"
          ></path></svg
        >
      </div>

      <!-- LABEL -->
      <span
        class="hidden md:block text-xs sm:text-sm md:text-base font-medium text-white uppercase tracking-wide overflow-hidden"
      >
        <span
          class="relative after:absolute after:-bottom-1 after:left-0 after:h-1 after:w-full after:origin-bottom-right after:scale-x-100 md:after:scale-x-0 after:bg-white after:transition-transform after:duration-300 after:ease-[cubic-bezier(0.65_0.05_0.36_1)] group-hover:after:origin-bottom-left group-hover:after:scale-x-100"
        >
          Ver m√°s
        </span>
      </span>
    </a>
  </div>

  <svg class="absolute w-0 h-0">
    <defs>
      <filter id="threshold">
        <feColorMatrix
          in="SourceGraphic"
          type="matrix"
          values=" 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 255 -140 "
        ></feColorMatrix>
      </filter>
    </defs>
  </svg>
</section>

<script>
  import { gsap } from "gsap";
  import { SplitText } from "gsap/SplitText";
  import { news } from "../data/NewsList";

  gsap.registerPlugin(SplitText);

  let cleanupHero: (() => void) | null = null;

  function initHero() {
    let animating = false;
    let autoplay = true;
    const AUTOPLAY_DELAY = 5000;

    const text1 = document.getElementById("text1") as HTMLSpanElement;
    const text2 = document.getElementById("text2") as HTMLSpanElement;

    const img1 = document.getElementById("img1") as HTMLImageElement;
    const img2 = document.getElementById("img2") as HTMLImageElement;

    const counter = document.getElementById("counter") as HTMLSpanElement;

    const btnNext = document.getElementById("next") as HTMLButtonElement;
    const btnPrev = document.getElementById("prev") as HTMLButtonElement;

    gsap.from([btnPrev, btnNext, ".p-counter", "#link"], {
      y: 20,
      opacity: 0.2,
      duration: 1,
      stagger: 0.035,
      ease: "expo.out",
    });

    const link = document.getElementById("link") as HTMLAnchorElement;

    const loader = document.getElementById("loader") as HTMLDivElement;

    let index = 0;

    img1.src = news[0].imagen;
    text1.textContent = news[0].title;
    counter.textContent = String(index + 1).padStart(2, "0");
    link.href = `/${news[0].slug}`;

    let splitText = SplitText.create("#text1", { type: "lines" });

    gsap.from(splitText.lines, {
      duration: 0.6,
      scale: 0.5,
      opacity: 0,
      stagger: 0.1,
      ease: "expo.out",
    });

    function animateLoader() {
      gsap.fromTo(
        loader,
        { scaleY: 0 },
        {
          scaleY: 1,
          duration: AUTOPLAY_DELAY / 1000,
          ease: "linear",
        }
      );
    }

    animateLoader();

    setInterval(() => {
      if (!autoplay) return;
      animateLoader();
      morphTo((index + 1) % news.length);
    }, AUTOPLAY_DELAY);

    function stopAutoPlay() {
      if (!autoplay) return;
      autoplay = false;
      gsap.killTweensOf(loader);
      gsap.set(loader, { scaleY: 0, duration: 1 });
    }

    function morphTo(nextIndex: number) {
      const next = news[nextIndex];
      const nextCounter = String(nextIndex + 1).padStart(2, "0");

      animating = true;

      text2.textContent = next.title;
      img2.src = next.imagen;
      link.href = `/${next.slug}`;

      const tl = gsap.timeline({
        defaults: { duration: 0.8, ease: "power2.out" },
        onComplete: () => {
          animating = false;
          setTimeout(() => {
            autoplay = true;
          }, 3500);
        },
      });

      tl.fromTo(
        img2,
        { opacity: 0, scale: 1.05, filter: "blur(8px)" },
        { opacity: 1, scale: 1, filter: "blur(0px)" },
        0
      )
        .to(img1, { opacity: 0, scale: 0.98, filter: "blur(8px)" }, 0)
        .to(counter, { y: -8, duration: 0.2 }, "<")
        .fromTo(
          counter,
          { y: 8, opacity: 0 },
          { y: 0, opacity: 1, duration: 0.2 },
          0.4
        )
        .fromTo(
          text2,
          { opacity: 0, filter: "blur(12px)" },
          { opacity: 1, filter: "blur(0px)" },
          0
        )
        .to(text1, { opacity: 0, filter: "blur(12px)" }, 0)
        .add(() => {
          text1.textContent = next.title;
          img1.src = next.imagen;
          counter.textContent = nextCounter;
        }, 0.4)

        .add(() => {
          gsap.set([text1, img1], {
            opacity: 1,
            filter: "blur(0px)",
            scale: 1,
          });
          gsap.set([text2, img2], { opacity: 0 });
          index = nextIndex;
        });
    }
    btnNext.addEventListener("click", () => {
      if (animating) return;
      stopAutoPlay();
      animateLoader();
      morphTo((index + 1) % news.length);
    });
    btnPrev.addEventListener("click", () => {
      if (animating) return;
      stopAutoPlay();
      animateLoader();
      morphTo((index - 1 + news.length) % news.length);
    });
  }

  document.addEventListener("astro:page-load", () => {
    if (document.querySelector("#img1")) {
      initHero();
    }
  });

  document.addEventListener("astro:before-swap", () => {
    cleanupHero?.();
    cleanupHero = null;
  });
</script>
