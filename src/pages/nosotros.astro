---
import Layout from "../layouts/Layout.astro";

const recomendaciones = [
  { label: "Hablar de Poesía", url: "https://hablardepoesia.com.ar/" },
  { label: "Historia del Arte", url: "https://historia-arte.com/" },
  { label: "Poeticous", url: "https://www.poeticous.com/poems?locale=es" },
  {
    label: "Ocean of books",
    url: "https://artsexperiments.withgoogle.com/ocean-of-books?author=robert-louis-stevenson&latitude=-49.2147&longitude=41.9307&zoom=9.66",
  },
  { label: "Aeon", url: "https://aeon.co/" },
];

const investigacion = ["La Nación", "Infobae", "Clarin", "Perfil"];

const services = [
  "Ensayo",
  "Investigación cultural",
  "Narrativas digitales",
  "Dirección editorial",
];

const contact = [
  {
    label: "Email",
    value: "revistaparrhesia@gmail.com",
    url: "mailto:revistaparrhesia",
  },
  {
    label: "Instagram",
    value: "Instagram",
    url: "https://www.instagram.com/bruugarcia_/",
  },
  {
    label: "Substack",
    value: "Substack",
    url: "https://substack.com/@bruugarcia",
  },
];
---

<Layout themeHeader={true}>
  <main
    class="clients relative flex flex-col w-full min-h-dvh overflow-hidden isolate bg-white pt-20 pb-5 sm:py-20"
  >
    <!-- Texto principal -->
    <section class="mx-3 sm:mx-5 space-y-4 z-20">
      <p
        class="split text-lg sm:text-xl md:text-2xl leading-5 md:leading-7 font-bold max-w-5xl text-pretty z-20"
        aria-hidden="true"
      >
        1. <b>El territorio de la duda</b>: Un pequeño halo de reverberación ha
        querido que este espacio sea un humilde bastión para la palabra. No
        pretendo poseer la verdad, sino defender el derecho a buscarla. Aquí, el
        pensamiento crítico es la única brújula permitida frente al avance de la
        superficialidad.
      </p>

      <p
        class="split text-lg sm:text-xl md:text-2xl leading-5 md:leading-7 font-bold max-w-4xl text-pretty z-20"
        aria-hidden="true"
      >
        2. <b>Un jardín de ideas</b>: El objetivo de este sitio es divulgar
        aquello que amo: la literatura, el arte, la política y la historia.
        Antes de que la muerte nos visite, quiero llenar este espacio con
        cuentos y filosofías que den sentido al acto de respirar. Si compartes
        este afán por expandir el lenguaje, te invito a colaborar.
      </p>
    </section>

    <div
      class="clients-preview fixed flex items-center justify-center inset-0 pointer-events-none z-0"
    >
    </div>

    <!-- Footer -->
    <footer
      class="flex flex-col gap-y-10 md:flex-row justify-between mx-3 sm:mx-5 pt-6 md:pt-12 mt-auto z-20"
    >
      <div
        class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-6 max-w-5xl w-full"
      >
        <!-- Confían -->
        <article class="max-w-xs appearance">
          <span class="text-neutral-700 uppercase font-heading text-base">
            Recomendaciones
          </span>
          <ul class="mt-1 text-base leading-relaxed clients-list">
            {
              recomendaciones.map((item, i) => (
                <a
                  href={item.url}
                  target="_blank"
                  class="client-name"
                  data-index={i}
                >
                  <span class="text-nowrap relative after:absolute after:bottom-0 after:left-0 after:h-0.5 after:w-full after:origin-bottom-left after:scale-x-100 after:bg-neutral-800 after:transition-transform after:duration-150 after:ease-in-out hover:after:origin-bottom-right hover:after:scale-x-0 mr-1.5 cursor-pointer">
                    {`${item.label}${i < recomendaciones.length - 1 ? "," : "."}`}
                  </span>
                </a>
              ))
            }
          </ul>
        </article>
        <!-- Prensa -->
        <article class="appearance">
          <span class="text-neutral-600 uppercase font-heading text-base">
            Prensa
          </span>
          <ul class="mt-1 text-base leading-relaxed">
            {
              investigacion.map((item, i) => (
                <li
                  data-index={i}
                  class="inline cursor-pointer mr-1.5 hover:text-amber-300 transition-colors duration-300"
                >
                  {`${item}${i < investigacion.length - 1 ? "," : "."}`}
                </li>
              ))
            }
          </ul>
        </article>

        <!-- Servicios -->
        <article class="appearance">
          <span class="text-neutral-700 uppercase font-heading text-base z-0">
            Servicios
          </span>
          <ul class="mt-1 text-base leading-relaxed text-balance">
            {
              services.map((item, i) => (
                <li class="service-name inline mr-1.5 relative after:absolute after:bottom-0 after:left-0 after:h-px after:bg-black after:w-full after:origin-bottom-right after:scale-x-0 after:transition-transform after:duration-300 after:ease-[cubic-bezier(0.65_0.05_0.36_1)] hover:after:origin-bottom-left hover:after:scale-x-100 cursor-pointer">
                  <span class="whitespace-nowrap">
                    {`${item}${i < services.length - 1 ? "," : "."}`}
                  </span>
                </li>
              ))
            }
          </ul>
        </article>

        <!-- Contacto -->
        <article class="appearance max-w-sm z-0">
          <span class="text-neutral-700 uppercase font-heading text-base z-0">
            Contacto
          </span>
          <ul class="mt-1 text-base leading-relaxed cursor-pointer">
            {
              contact.map((item) => (
                <li>
                  <a
                    href={item.url}
                    target="_blank"
                    class="hover:text-amber-300 transition-colors duration-300"
                  >
                    {item.value}
                  </a>
                </li>
              ))
            }
          </ul>
        </article>
      </div>

      <!-- Call to action -->
      <div
        class="flex flex-col items-center md:items-end justify-between w-full min-h-full lg:mr-12"
      >
        <div
          class="md:hidden w-full border-t-2 border-dashed border-black mt-4 md:mt-7"
        >
        </div>
        <h3
          class="split mt-4 md:mt-0 text-3xl md:text-4xl lg:text-5xl z-0 text-center md:text-end text-balance max-w-none md:max-w-md font-bold font-heading uppercase"
          style="filter: url(#threshold)"
        >
          Pensar el presente. Publicar sin concesiones.
        </h3>
        <a
          id="colabs"
          href="mailto:brunogalberti@gmail.com"
          class="appearance flex justify-end text-center w-full max-w-md md:max-w-md group mt-4 md:mt-auto cursor-pointer"
          ><span
            class="w-full max-w-md md:max-w-lg py-2 rounded-[.2rem] bg-black group-hover:bg-transparent border border-transparent group-hover:border-dashed group-hover:border-black group-hover:text-black transition-colors duration-300 text-white"
            >Proponer una colaboración</span
          ></a
        >
      </div>
    </footer>
    <svg class="absolute w-0 h-0">
      <defs>
        <filter id="threshold">
          <feColorMatrix
            in="SourceGraphic"
            type="matrix"
            values=" 1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 255 -140 "
          ></feColorMatrix>
        </filter>
      </defs>
    </svg>
  </main>
</Layout>

<style>
  .clients-preview {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
  }

  .client-img-wrapper {
    position: absolute;
    will-change: transform, opacity, clip-path;
  }

  .client-img-wrapper img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
</style>

<script>
  import gsap from "gsap";
  import SplitText from "gsap/SplitText";

  import img1 from "../assets/simulations/img1.webp";
  import img2 from "../assets/simulations/img2.webp";
  import img3 from "../assets/simulations/img3.webp";
  import img4 from "../assets/simulations/img4.webp";
  import img5 from "../assets/simulations/img5.webp";

  import services1 from "../assets/photos/services1.webp";
  import services2 from "../assets/photos/services2.webp";
  import services3 from "../assets/photos/services3.webp";
  import services4 from "../assets/photos/services4.webp";

  import type { ImageMetadata } from "astro";

  gsap.registerPlugin(SplitText);

  const trustedImgs = [img1, img2, img3, img4, img5];

  const servicesImgs = [services1, services2, services3, services4];

  let activeIndex = -1;
  let activeWrapper: HTMLDivElement | null = null;
  let activeImg: HTMLImageElement | null = null;

  function preloadImages(images: ImageMetadata[]) {
    images.forEach((item) => {
      const img = new Image();
      img.src = item.src;
    });
  }

  function hardClearActiveImage() {
    if (!activeWrapper) return;

    gsap.killTweensOf(activeWrapper);
    gsap.killTweensOf(activeImg);

    activeWrapper.remove();

    activeWrapper = null;
    activeImg = null;
    activeIndex = -1;
  }

  function clearActiveImage() {
    if (!activeWrapper) return;

    gsap.killTweensOf(activeWrapper);
    gsap.killTweensOf(activeImg);

    const wrapper = activeWrapper;

    activeWrapper = null;
    activeImg = null;
    activeIndex = -1;

    gsap.to(wrapper, {
      opacity: 0,
      scale: 0.95,
      duration: 0.4,
      ease: "power2.out",
      onComplete: () => wrapper.remove(),
    });
  }

  function initHoverImages(selector: string, images: ImageMetadata[]) {
    const items = document.querySelectorAll<HTMLElement>(selector);
    const preview = document.querySelector<HTMLElement>(".clients-preview");

    if (!items.length || !preview) return;

    items.forEach((item, index) => {
      item.addEventListener("mouseenter", () => {
        if (!images[index]) return;
        if (index === activeIndex) return;

        hardClearActiveImage();
        activeIndex = index;

        const wrapper = document.createElement("div");
        wrapper.className = "client-img-wrapper";

        const img = document.createElement("img");
        img.src = images[index].src;

        img.onload = () => {
          const { naturalWidth, naturalHeight } = img;

          const maxW = window.innerWidth * 0.9;
          const maxH = window.innerHeight * 0.8;

          const scale = Math.min(maxW / naturalWidth, maxH / naturalHeight, 1);

          wrapper.style.width = `${naturalWidth * scale}px`;
          wrapper.style.height = `${naturalHeight * scale}px`;

          preview.appendChild(wrapper);
          wrapper.appendChild(img);

          // Fuerza cálculo de layout
          wrapper.getBoundingClientRect();

          gsap.set(wrapper, {
            scale: 1.05,
            opacity: 0,
            clipPath: "polygon(50% 50%, 50% 50%, 50% 50%, 50% 50%)",
          });

          activeWrapper = wrapper;
          activeImg = img;

          gsap.to(wrapper, {
            clipPath: "polygon(0% 0%, 100% 0%, 100% 100%, 0% 100%)",
            duration: 0.8,
            ease: "power3.inOut",
          });

          gsap.to(wrapper, {
            opacity: 1,
            scale: 1,
            duration: 1.2,
            ease: "power3.out",
          });
        };
      });

      item.addEventListener("mouseleave", hardClearActiveImage);
    });
  }

  function initPageAnimations() {
    preloadImages(trustedImgs);
    preloadImages(servicesImgs);

    initHoverImages(".client-name", trustedImgs);
    initHoverImages(".service-name", servicesImgs);

    document.fonts.ready.then(() => {
      gsap.set(".split", { opacity: 1 });

      SplitText.create(".split", {
        type: "lines",
        autoSplit: true,
        mask: "lines",
        onSplit: (self) =>
          gsap.from(self.lines, {
            yPercent: 100,
            opacity: 0,
            stagger: 0.1,
            duration: 0.6,
            ease: "expo.out",
          }),
      });

      gsap.from(".appearance", {
        scale: 0.5,
        opacity: 0,
        duration: 0.8,
        stagger: 0.1,
        ease: "expo.out",
      });
    });
  }

  function cleanupPage() {
    hardClearActiveImage();
  }

  document.addEventListener("astro:page-load", initPageAnimations);
  document.addEventListener("astro:before-swap", cleanupPage);
</script>
