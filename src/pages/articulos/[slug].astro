---
import Layout from "../../layouts/Layout.astro";
import Footer from "../../components/Footer.astro";

import facebook from "../../assets/svgs/facebook-icon.svg";
import instagram from "../../assets/svgs/instagram-icon.svg";
import github from "../../assets/svgs/github_dark.svg";
import link from "../../assets/svgs/link.svg";
import x from "../../assets/svgs/x_dark.svg";
import linkedin from "../../assets/svgs/linkedin.svg";

import { getCollection } from "astro:content";
import { getEntry } from "astro:content";

export const prerender = true;

export async function getStaticPaths() {
  const articulos = await getCollection("articulos");

  return articulos.map((art) => ({
    params: { slug: art.slug },
    props: { art },
  }));
}

const { art } = Astro.props;

const authors = (
  await Promise.all(
    art.data.autores.map(async (slug) => {
      try {
        return await getEntry("autores", slug);
      } catch {
        return null;
      }
    })
  )
).filter(Boolean);

const { Content } = await art.render();
---

<Layout
  themeHeader={false}
  title={`${art.data.title} — Revista Parrhesia`}
  description={art.data.subtitulo +
    "— Pensar el presente. Publicar sin concesiones."}
  image={art.data.imagen}
  canonical={`https://revista-parrhesia.vercel.app/articulos/${art.slug}`}
>
  <main class="w-full overflow-hidden bg-neutral-800">
    <section
      class="flex flex-col justify-center pb-8 pt-24 md:pb-16 md:pt-32 px-2 sm:px-5 md:px-0 h-full bg-neutral-800 text-white"
    >
      <div
        id="category"
        class="px-5 py-1 bg-amber-300 opacity-0 uppercase font-heading font-bold text-sm md:text-base mx-auto text-center mb-5"
      >
        {art.data.categoria}
      </div>
      <p
        id="subtitle"
        class="uppercase font-semibold text-base md:text-lg leading-5 sm:leading-6 text-center max-w-xl md:max-w-2xl mx-auto text-pretty"
      >
        {art.data.subtitulo}
      </p>
      <div
        class="w-48 md:w-56 mx-auto opacity-0 border-t-4 border-dashed border-amber-300 mt-4 md:mt-7"
      >
      </div>
      <h1
        class="uppercase font-bold opacity-0 font-heading text-center text-2xl sm:text-3xl md:text-4xl mt-6 md:mt-8"
      >
        {art.data.title}
      </h1>
      <div
        class="relative w-full max-w-3xl mx-auto mt-6 md:mt-8 aspect-video rounded-[.2rem] overflow-hidden"
      >
        <img
          src={art.data.imagen}
          alt={art.data.title}
          class="absolute inset-0 w-full h-full opacity-0 object-cover"
        />
      </div>
      <article
        class="content-article relative prose dark:prose-invert max-w-none md:max-w-4xl mx-auto max-[690px]:px-2 px-4 py-4 w-full prose-video:mx-auto prose-video:rounded-[10px] prose-video:w-full prose-hr:my-2 prose-blockquote:leading-5 prose-blockquote:text-neutral-600 dark:prose-blockquote:text-neutral-400 prose-img:w-auto prose-img:mx-auto prose-img:rounded-[10px] prose-img:max-h-80"
      >
        <Content />
      </article>
      {
        authors.map((author) => (
          <div class="content-author flex items-end justify-end gap-4 mt-8 w-full max-w-5xl mx-auto">
            <div class="flex flex-col text-right">
              <p class="font-bold">{author?.data.name}</p>

              {author?.data.role && (
                <p class="text-sm opacity-70">{author?.data.role}</p>
              )}

              {author?.data.socials && (
                <ul class="flex justify-end items-center gap-3 mt-2">
                  {author?.data.socials.instagram && (
                    <li>
                      <a
                        href={author?.data.socials.instagram}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="Instagram"
                      >
                        <img
                          src={instagram.src}
                          alt="Instagram"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}

                  {author?.data.socials.facebook && (
                    <li>
                      <a
                        href={author?.data.socials.facebook}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="Facebook"
                      >
                        <img
                          src={facebook.src}
                          alt="Facebook"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}

                  {author?.data.socials.github && (
                    <li>
                      <a
                        href={author?.data.socials.github}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="GitHub"
                      >
                        <img
                          src={github.src}
                          alt="GitHub"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}

                  {author?.data.socials.linkedin && (
                    <li>
                      <a
                        href={author?.data.socials.linkedin}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="LinkedIn"
                      >
                        <img
                          src={linkedin.src}
                          alt="LinkedIn"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}

                  {author?.data.socials.x && (
                    <li>
                      <a
                        href={author?.data.socials.x}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="X"
                      >
                        <img
                          src={x.src}
                          alt="X"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}

                  {author?.data.socials.website && (
                    <li>
                      <a
                        href={author?.data.socials.website}
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="Sitio web"
                      >
                        <img
                          src={link.src}
                          alt="Website"
                          class="w-4 h-4 opacity-70 hover:opacity-100 transition"
                        />
                      </a>
                    </li>
                  )}
                </ul>
              )}
            </div>
          </div>
        ))
      }
    </section>
    <Footer />
  </main>
</Layout>

<script>
  import gsap from "gsap";
  import SplitText from "gsap/SplitText";

  gsap.registerPlugin(SplitText);

  function initPageAnimations() {
    const category = document.getElementById("category");
    const subtitle = document.getElementById("subtitle");
    const title = document.querySelector("h1");
    const image = document.querySelector("section img");
    const rule = document.querySelector(".border-dashed");

    if (!category || !subtitle) return;

    // Split subtitle
    const splitSubtitle = new SplitText(subtitle, {
      type: "words",
      wordsClass: "word",
    });

    gsap.set([category, title, rule], {
      opacity: 0,
      y: 20,
    });

    gsap.set(image, {
      scale: 0.8,
      opacity: 0,
    });

    gsap.set(splitSubtitle.words, {
      opacity: 0,
      y: 10,
    });

    gsap.set(".content-article", {
      opacity: 0,
      y: 10,
    });

    gsap.set(".content-author", {
      opacity: 0,
      y: 10,
    });

    const tl = gsap.timeline({
      defaults: {
        ease: "expo.out",
      },
    });

    tl.to(category, {
      opacity: 1,
      y: 0,
      duration: 0.6,
    })
      .to(
        splitSubtitle.words,
        {
          opacity: 1,
          y: 0,
          stagger: 0.03,
          duration: 0.6,
        },
        "-=0.2"
      )
      .to(
        rule,
        {
          opacity: 1,
          y: 0,
          duration: 0.5,
        },
        "-=0.3"
      )
      .to(
        title,
        {
          opacity: 1,
          y: 0,
          duration: 0.6,
        },
        "-=0.4"
      )
      .to(
        image,
        {
          opacity: 1,
          scale: 1,
          duration: 0.8,
        },
        "-=0.5"
      )
      .to(
        ".content-article",
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
        },
        "-=0.5"
      )
      .to(
        ".content-author",
        {
          opacity: 1,
          y: 0,
          duration: 0.8,
        },
        "<"
      );
  }

  document.addEventListener("astro:page-load", initPageAnimations);
</script>
